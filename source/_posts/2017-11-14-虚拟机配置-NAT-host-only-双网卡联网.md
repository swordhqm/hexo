---
title: '虚拟机配置(NAT,host-only)双网卡联网'
date: 2017-11-14 21:09:43
tags:
    - tool
categories:
    - IT
---

# 虚拟机网卡添加
**添加NAT网卡**
![添加 NAT网卡][NAT网卡]

**添加host-only网卡**
![添加 host-only网卡][host-only网卡]

**确保VirtualBox Host-Only Network启用**
![启用host-only adapter][启用host-only adapter]

# 网络连接方式
一般而言，平时办公应用常见场景：
* 主机通过磁盘映射访问虚拟机 - 虚拟机需要开启samba
* 客户机能上网

**解决方案**
* NAT模式将虚拟机放入了独立子网，采用DHCP模式获取地址。由于virtual box机制，有固定信息：
ip: 测试被分配为10.0.2.15
gateway: 10.0.2.2(固定)
netmask: 255.255.255.0

由于碰到NAT无法联网，顺便提到这块解决问题需要留意的点:

```    
1. 需要去看路由表信息
linux上路由表信息，可以通过route -n进行查看
直接给出来正确路由信息样式 --
[kevin@localhost hexo]$ route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         10.0.2.2        0.0.0.0         UG    0      0        0 enp0s3
10.0.2.0        0.0.0.0         255.255.255.0   U     0      0        0 enp0s3
169.254.0.0     0.0.0.0         255.255.0.0     U     1002   0        0 enp0s3
169.254.0.0     0.0.0.0         255.255.0.0     U     1003   0        0 enp0s8
172.17.0.0      0.0.0.0         255.255.0.0     U     0      0        0 docker0
192.168.1.0     0.0.0.0         255.255.255.0   U     0      0        0 enp0s8
这里有可能出现多个默认路由 就是那个UG，需要通过最大前缀匹配，判断是否是通过10.0.2.2转发对外访问，不然就不能访问外部网络。
....
另外通过traceroute 22.124.234.22 随便一个外网地址，看看是不是过的10.0.2.2这个网关。
[kevin@localhost hexo]$ traceroute 22.124.234.22
traceroute to 22.124.234.22 (22.124.234.22), 30 hops max, 60 byte packets
1  gateway (10.0.2.2)  0.271 ms  0.145 ms  0.089 ms^[^A
....
enp0s3 对应 NAT网卡
enp0s8 对应 host-only方式网卡
路由信息匹配按最长前缀匹配，也就是说192.168.1.x的访问都是通过enp0s8完成的。而其他的会走enp0s3。

上面信息可以翻译为：
line1 我是本地路由，我知道从10.0.2.2 这个网关 可以把packet送到任何地方去，而且这个packet是通过enp0s3转到网关的
line2 我是本地路由，如果外网要发packet到10.0.2.x这个子网，我知道怎么走，只需要把packet给到enp0s3就可以了。

#https://www.zhihu.com/question/20465477
交换机工作在链路层（第二层），路由器工作在网络层（第三层）
交换机转发所依据的对象时：MAC地址。（物理地址）
路由转发所依据的对象是：IP地址。（网络地址）
交换机主要用于组建局域网，
而路由主要功能是将由交换机组好的局域网相互连接起来，或者接入Internet。

NAT原理及应用
http://blog.csdn.net/xiaofei0859/article/details/6630467
....
碰到bug情况，在网络设定里都设置正确，但是也不知道是不是自己在virtual box上乱切换mac，导致网络问题。修复过程中又碰到NetworkManager无法设定dns。
```

* 不使用NetworkManager完成网络配置

```
#关闭NetworkManager
systemctl stop NetworkManager
systemctl disable NetworkManager
```

```
#开启network
systemctl enable network
systemctl start network

这里需要注意的是，留意报错情况，可能无法启动。正常情况下需要重启确认。如果无法启动，需要逐步排查问题。

系统是否已经具有两个网卡设备？
[root@localhost hexo]# cat /proc/net/dev
这里一般就会看到有enp0s3, enp0s8

我这边碰到的是enp0s8 这个设备在ifconfig -a, 看不见。
这个时候需要，加入ifcfg-enp0s8。
[root@localhost network-scripts]# pwd
/etc/sysconfig/network-scripts
[root@localhost network-scripts]# ls ifcfg-*
ifcfg-enp0s3  ifcfg-enp0s8  ifcfg-lo

贴出来ifcfg-enp0s3详细信息：
[root@localhost network-scripts]# cat ifcfg-enp0s3 
HWADDR=08:00:27:b2:92:61    #很重要，需要与vbox里网卡的mac一致
TYPE=Ethernet
BOOTPROTO=dhcp
DEFROUTE=yes    #很重要，因为NAT网卡就是访问外网用的
IPV4_FAILURE_FATAL=no
IPV6INIT=yes
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_FAILURE_FATAL=no
NAME=enp0s3 #很重要
#这个UUID 可以通过命令 uuidgen enp0s3 生成，如果不知道
UUID=436a1443-3e28-4d3e-ad8a-afbded6cbcf9
ONBOOT=yes
PEERDNS=yes
PEERROUTES=yes
IPV6_PEERDNS=yes
IPV6_PEERROUTES=yes


贴出来ifcfg-enp0s8详细信息，可以看到这个信息是静态配置的:
[root@localhost network-scripts]# cat ifcfg-enp0s8 
TYPE=Ethernet
BOOTPROTO=none
DEFROUTE=no
IPV4_FAILURE_FATAL=no
IPV6INIT=yes
IPV6_AUTOCONF=yes
IPV6_DEFROUTE=yes
IPV6_FAILURE_FATAL=no
IPV6_ADDR_GEN_MODE=stable-privacy
NAME=enp0s8 #重要
UUID=b27fd86f-0fe0-4b8b-9df3-ef785c93f8e2   #uuidgen生成
ONBOOT=yes
DNS1=114.114.114.114
IPADDR=192.168.1.25
PREFIX=24
GATEWAY=192.168.1.24
IPV6_PEERDNS=yes
IPV6_PEERROUTES=yes
DEVICE=enp0s8  #非常重要，好像不设置还不行

这个时候，可以用ifup enp0s8 尝试开启网卡

后续发现NAT模式无法联网，但是各个信息都检测一致，这个时候发现是dns问题。需要写入resolv.conf,来实现DNS配置。
[root@localhost etc]# pwd
/etc
[root@localhost etc]# cat resolv.conf
; generated by /usr/sbin/dhclient-script
nameserver 114.114.114.114
nameserver 202.96.128.166
search localdomain  #这个localdomain 要与hosts文件中的信息一致
[root@localhost etc]# cat hosts
127.0.0.1       localhost.localdomain localhost
::1     localhost6.localdomain6 localhost6

重启network
systemctl restart network

最后检查主机和虚拟机间磁盘映射 以及虚拟机自身的网络访问情况
```

***********
[NAT网卡]: /img/虚拟机网络(NAT，host-only)/NAT.bmp
[host-only网卡]: /img/虚拟机网络(NAT，host-only)/host-only.bmp
[启用host-only adapter]: /img/虚拟机网络(NAT，host-only)/s4.bmp

